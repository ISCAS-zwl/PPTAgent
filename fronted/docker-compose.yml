version: '3.8'

# 完整的 PPTAgent + Frontend 集成部署配置
# 使用方法: docker-compose -f docker-compose.full.yml up -d

services:
  # ============ DeepPresenter 核心服务 ============

  # DeepPresenter Host 容器 - 运行 AgentLoop 和 API 服务
  deeppresenter-host:
    image: deeppresenter-host:0.1.0  # 使用根目录 docker-compose.yml 构建的镜像
    container_name: deeppresenter-host
    ports:
      - "4397:4397"  # API 服务
    environment:
      - DEEPPRESENTER_WORKSPACE_BASE=/opt/workspace
      # HOST_WORKSPACE_BASE 必须是主机上的真实路径，用于 sandbox 容器挂载
      - DEEPPRESENTER_HOST_WORKSPACE_BASE=${PWD}/../workspace
      # 日志级别: 0=debug, 10=info, 20=warning
      - DEEPPRESENTER_LOG_LEVEL=0
      # 代理设置 - 用于 HuggingFace 模型下载
      - HTTP_PROXY=http://192.168.14.16:4251
      - HTTPS_PROXY=http://192.168.14.16:4251
      - http_proxy=http://192.168.14.16:4251
      - https_proxy=http://192.168.14.16:4251
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      # 使用主机目录挂载而不是 Docker volume，以便 sandbox 容器可以访问
      - ../workspace:/opt/workspace
      # 挂载整个 deeppresenter 目录，包含 pyproject.toml
      - ../deeppresenter:/usr/src/pptagent/deeppresenter
    networks:
      - pptagent-network
    restart: unless-stopped
    privileged: true
    # 使用镜像默认的启动脚本 /usr/src/pptagent/start_services.sh

  # ============ 前端系统服务 ============

  # Redis - 任务队列和缓存
  redis:
    image: docker.1ms.run/library/redis:7.4.7-alpine3.21
    container_name: pptagent-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - pptagent-network
    restart: unless-stopped

  # Backend - FastAPI 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: pptagent-backend
    ports:
      - "8000:8000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - API_HOST=0.0.0.0
      - API_PORT=8000
      # 允许所有来源访问（生产环境建议设置具体域名）
      - CORS_ORIGINS=*
      - PPTAGENT_DOCKER_URL=http://deeppresenter-host:4397
      - PPTAGENT_MODE=docker
      - PPTAGENT_WORKSPACE=/workspace
    depends_on:
      - redis
      - deeppresenter-host
    volumes:
      - ./backend:/app
      - ../workspace:/workspace
    networks:
      - pptagent-network
    restart: unless-stopped

  # Frontend - Next.js 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: pptagent-frontend
    # 不再直接暴露端口，通过 Nginx 代理访问
    # ports:
    #   - "3000:3000"
    environment:
      # 使用相对路径，通过 Nginx 代理访问后端
      - NEXT_PUBLIC_API_URL=
      - NEXT_PUBLIC_WS_URL=
    depends_on:
      - backend
    networks:
      - pptagent-network
    restart: unless-stopped

  # Nginx - 反向代理服务
  nginx:
    image: docker.1ms.run/library/nginx:alpine
    container_name: pptagent-nginx
    ports:
      # 使用 4399 端口
      # 用户访问 http://服务器IP:4399/
      - "4399:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
    networks:
      - pptagent-network
    restart: unless-stopped

volumes:
  redis_data:

networks:
  pptagent-network:
    driver: bridge
